var ilabAttachmentInfo=function(a,b,c){var d=this;this.info=a(b.attachmentTemplate(c)),this.data=c,this.attachmentTitle=this.info.find('input[name="attachment-title"]'),this.attachmentCaption=this.info.find('textarea[name="attachment-caption"]'),this.attachmentAlt=this.info.find('input[name="attachment-alt"]'),this.attachmentDescription=this.info.find('textarea[name="attachment-description"]'),this.attachmentAlign=this.info.find('select[name="attachment-align"]'),this.attachmentLinkURL=this.info.find('input[name="attachment-link-url"]'),this.attachmentSize=this.info.find('select[name="attachment-size"]'),this.attachmentLinkType=this.info.find('select[name="attachment-link-type"]'),this.saveToken=null;var e=function(){var b={action:'save-attachment',id:d.data.id,nonce:d.data.nonces.update,post_id:window.parent.wp.media.model.settings.post.id,"changes[title]":d.attachmentTitle.val(),"changes[caption]":d.attachmentCaption.val(),"changes[alt]":d.attachmentAlt.val(),"changes[description]":d.attachmentDescription.val()};a.post(ajaxurl,b,function(){})};this.save=function(){clearTimeout(d.saveToken),d.saveToken=setTimeout(e,1e3)};var f=function(){d.save()};this.attachmentTitle.on('change',f),this.attachmentCaption.on('change',f),this.attachmentAlt.on('change',f),this.attachmentDescription.on('change',f),this.attachmentLinkType.on('change',function(){var a=d.attachmentLinkType.val();'none'==a?(d.attachmentLinkURL.css({display:'display'}),d.attachmentLinkURL.val('')):'file'==a?(d.attachmentLinkURL.prop('readonly','readonly'),d.attachmentLinkURL.css({display:''}),d.attachmentLinkURL.val(d.data.url)):'post'==a?(d.attachmentLinkURL.prop('readonly','readonly'),d.attachmentLinkURL.css({display:''}),d.attachmentLinkURL.val(d.data.link)):'custom'==a&&(d.attachmentLinkURL.prop('readonly',null),d.attachmentLinkURL.css({display:''}),d.attachmentLinkURL.val(''))}),this.insert=function(){var b={action:'send-attachment-to-editor',"attachment[id]":d.data.id,nonce:window.parent.wp.media.view.settings.nonce.sendToEditor,post_id:window.parent.wp.media.model.settings.post.id,"attachment[post_content]":d.attachmentDescription.val(),"attachment[post_excerpt]":d.attachmentCaption.val(),"attachment[image_alt]":d.attachmentAlt.val(),"attachment[image-size]":d.attachmentSize.val(),"attachment[align]":d.attachmentAlign.val(),"attachment[url]":d.attachmentLinkURL.val(),html:''};a.post(ajaxurl,b,function(a){a.hasOwnProperty('data')&&window.parent.send_to_editor(a.data)})},this.attachmentLinkURL.css({display:'none'}),b.attachmentContainer.empty(),b.attachmentContainer.append(this.info)},ilabMediaUploadItem=function(a,b,c){var d=this;this.cell=a(b.uploadItemTemplate()),this.background=this.cell.find('.ilab-upload-item-background'),this.status=this.cell.find('.ilab-upload-status'),this.progress=this.cell.find('.ilab-upload-progress'),this.progressTrack=this.cell.find('.ilab-upload-progress-track'),this.status.text('Waiting ...'),this.progressTrack.css({width:'0%'}),this.cell.css({opacity:0}),this.cell.addClass('no-mouse'),this.state='waiting',this.postId=null,this.loader=this.cell.find('.ilab-loader-container'),0==c.type.indexOf('image/')&&c.size<15728640?this.background.css({opacity:0.33,"background-image":'url('+URL.createObjectURL(c)+')'}):0==c.type.indexOf('image/')?this.cell.addClass('ilab-upload-cell-image'):0==c.type.indexOf('video/')?this.cell.addClass('ilab-upload-cell-video'):'application/x-photoshop'==c.type?this.cell.addClass('ilab-upload-cell-image'):this.cell.addClass('ilab-upload-cell-doc'),this.deselect=function(){this.cell.removeClass('ilab-upload-selected')},this.updateProgress=function(a){this.progressTrack.css({width:Math.floor(100*a)+'%'})},this.itemUploaded=function(a,c){if(a){if(this.progress.css({display:'none'}),this.status.css({display:'none'}),this.background.css({opacity:''}),this.state='ready',this.postId=c.data.id,c.data.thumb){this.loader.css({opacity:1});var d=new Image;d.onload=function(){this.background.css({"background-image":'url('+c.data.thumb+')'}),this.loader.css({opacity:0})}.bind(this),d.src=c.data.thumb}this.cell.removeClass('no-mouse')}else this.progress.css({display:'none'}),this.status.text('Error.'),this.cell.addClass('upload-error');b.uploadFinished(this)},this.itemUploadError=function(){d.progress.css({display:'none'}),d.status.text('Error uploading.'),b.uploadFinished(d)},this.updateStatusText=function(){this.status.text('Uploading ...')},this.startUpload=function(){var b=new this.storageUploader(a,this,c);b.start()},b.uploadTarget.append(this.cell),setTimeout(function(){d.cell.css({opacity:''})},1e3/30),this.cell.on('click',function(a){if('ready'==d.state)if(b.settings.insertMode)d.cell.addClass('ilab-upload-selected'),b.uploadSelected(d);else{var c=window.open('post.php?post='+d.postId+'&action=edit','_blank');c.focus()}return a.preventDefault(),!1})},ilabMediaUploader=function(a,b){var c=this;this.insertButton=a('#ilab-insert-button'),this.settings=b,this.uploadTarget=a('#ilab-video-upload-target'),this.attachmentContainer=a('#ilab-attachment-info'),this.uploadDirections=this.uploadTarget.find('.ilab-upload-directions'),this.uploadItemTemplate=wp.template('ilab-upload-cell'),this.attachmentTemplate=wp.template('ilab-attachment-info'),this.hiddenFileInput=a('<input type="file" style="visibility:hidden" multiple="multiple">'),this.waitingQueue=[],this.uploadingQueue=[],this.watchToken=null,this.currentSelection=null,this.attachmentInfo=null,this.watchQueue=function(){if(5>c.uploadingQueue.length&&0<c.waitingQueue.length)for(var a=5-c.uploadingQueue.length,b=0;b<a;b++)if(0<c.waitingQueue.length){var d=c.waitingQueue.shift();c.uploadingQueue.push(d),d.startUpload()}c.watchToken=setTimeout(c.watchQueue,500)},this.uploadSelected=function(b){if(c.currentSelection!=b){c.insertButton.prop('disabled',!0),c.currentSelection&&c.currentSelection.deselect(),c.currentSelection=b;var d={action:'ilab_upload_attachment_info',postId:b.postId};a.post(ajaxurl,d,function(b){a('body').addClass('ilab-item-selected'),c.attachmentInfo=new ilabAttachmentInfo(a,c,b),c.insertButton.prop('disabled',!1)})}},this.uploadFinished=function(a){var b=c.uploadingQueue.indexOf(a);-1<b&&c.uploadingQueue.splice(b,1),clearTimeout(c.watchToken),c.watchQueue()},this.addFile=function(d){if(''==d.type)return!1;var e=d.type;if('application/x-photoshop'==e&&(e='image/psd'),-1==b.allowedMimes.indexOf(e))return!1;var f=e.split('/'),g=f[0],h=f[1];if('image'==g){if(!b.imgixEnabled)return!1;if(-1==['jpeg','gif','png'].indexOf(h)){if(!b.extrasEnabled)return!1;if(-1==['psd','tiff','bmp'].indexOf(h))return!1}}else if('video'==g){if(!b.videoEnabled)return!1;}else if(!b.docsEnabled)return!1;c.waitingQueue.push(new ilabMediaUploadItem(a,c,d))},this.uploadTarget.on('dragenter dragover',function(a){c.uploadTarget.addClass('drag-inside'),a.stopPropagation(),a.preventDefault()}),this.uploadTarget.on('dragleave drageexit',function(a){c.uploadTarget.removeClass('drag-inside'),a.stopPropagation(),a.preventDefault()}),this.uploadTarget.on('drop',function(a){c.uploadTarget.removeClass('drag-inside'),c.uploadDirections.css({display:'none'}),a.preventDefault();var b=a.originalEvent.dataTransfer.files;_.each(b,c.addFile)}),this.uploadTarget.on('click',function(){c.hiddenFileInput.click()}),this.hiddenFileInput.on('change',function(){c.uploadDirections.css({display:'none'});for(var a=0;a<this.files.length;a++)c.addFile(this.files[a])}),a('#ilab-open-editor').on('click',function(a){return wp.media({frame:'select'}).open(),a.preventDefault(),!1}),this.insertButton.on('click',function(a){return c.attachmentInfo&&c.attachmentInfo.insert(),a.preventDefault(),!1}),b.insertMode&&a('body').addClass('ilab-upload-insert-mode'),this.watchToken=setTimeout(this.watchQueue,500)};